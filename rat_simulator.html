<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Lab Rat Population Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }
        
        .ui-panel {
            position: absolute;
            background: rgba(0,0,0,0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(5px);
        }
        
        .controls {
            top: 20px;
            left: 20px;
            width: 280px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .stats {
            top: 20px;
            right: 20px;
            width: 300px;
        }
        
        .header {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            padding: 10px 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            color: #4ecdc4;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        .slider-row {
            margin-bottom: 12px;
        }
        
        .slider-row label {
            display: block;
            font-size: 0.9em;
            margin-bottom: 3px;
        }
        
        .slider {
            width: 100%;
            height: 20px;
        }
        
        .button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin: 2px;
            font-size: 0.9em;
        }
        
        .button:hover {
            opacity: 0.8;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        
        .stat-value {
            color: #4ecdc4;
            font-weight: bold;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8em;
        }
        
        .status-item.critical {
            background: rgba(255,0,0,0.3);
        }
        
        .alert {
            background: rgba(255,0,0,0.2);
            border: 1px solid #f44336;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            display: none;
            font-size: 0.85em;
        }
        
        .alert.show { display: block; }
        
        .camera-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        #debug {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8em;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div class="ui-panel header">
        <h2>3D Lab Rat Population Simulator</h2>
        <p>Based on Scientific Research</p>
    </div>

    <div class="ui-panel controls">
        <div class="control-group">
            <h3>Environment</h3>
            <div class="slider-row">
                <label>Carrying Capacity: <span id="capacityVal">100</span></label>
                <input type="range" min="20" max="300" value="100" class="slider" id="capacity">
            </div>
            <div class="slider-row">
                <label>Food Level: <span id="foodVal">100%</span></label>
                <input type="range" min="20" max="200" value="100" class="slider" id="food">
            </div>
            <div class="slider-row">
                <label>Stress Factor: <span id="stressVal">Normal</span></label>
                <input type="range" min="50" max="200" value="100" class="slider" id="stress">
            </div>
        </div>

        <div class="control-group">
            <h3>Simulation</h3>
            <button class="button" id="startBtn">Start</button>
            <button class="button" id="pauseBtn">Pause</button>
            <button class="button" id="resetBtn">Reset</button>
            <div class="slider-row">
                <label>Speed: <span id="speedVal">1x</span></label>
                <input type="range" min="1" max="10" value="3" class="slider" id="speed">
            </div>
        </div>

        <div class="control-group">
            <h3>Camera</h3>
            <button class="button" id="topView">Top View</button>
            <button class="button" id="sideView">Side View</button>
            <button class="button" id="freeView">Free Cam</button>
        </div>
    </div>

    <div class="ui-panel stats">
        <h3 style="color: #4ecdc4; margin-bottom: 10px;">Population Stats</h3>
        <div class="stat-row">
            <span>Total Population:</span>
            <span class="stat-value" id="totalPop">0</span>
        </div>
        <div class="stat-row">
            <span>Adults:</span>
            <span class="stat-value" id="adults">0</span>
        </div>
        <div class="stat-row">
            <span>Juveniles:</span>
            <span class="stat-value" id="juveniles">0</span>
        </div>
        <div class="stat-row">
            <span>Births/Day:</span>
            <span class="stat-value" id="births">0</span>
        </div>
        <div class="stat-row">
            <span>Deaths/Day:</span>
            <span class="stat-value" id="deaths">0</span>
        </div>

        <h3 style="color: #4ecdc4; margin: 15px 0 10px 0;">Behavioral Status</h3>
        <div class="status-grid">
            <div class="status-item" id="stressStatus">
                <div>Stress</div>
                <div id="stressLevel">Normal</div>
            </div>
            <div class="status-item" id="aggressionStatus">
                <div>Aggression</div>
                <div id="aggressionLevel">Low</div>
            </div>
            <div class="status-item" id="reproductionStatus">
                <div>Reproduction</div>
                <div id="reproductionLevel">Normal</div>
            </div>
            <div class="status-item" id="cannibalismStatus">
                <div>Cannibalism</div>
                <div id="cannibalismLevel">None</div>
            </div>
        </div>

        <h3 style="color: #4ecdc4; margin: 15px 0 10px 0;">Research Data</h3>
        <div class="stat-row">
            <span>Density:</span>
            <span class="stat-value" id="density">0%</span>
        </div>
        <div class="stat-row">
            <span>Avg Interactions:</span>
            <span class="stat-value" id="interactions">0</span>
        </div>
        <div class="stat-row">
            <span>Stress Hormone:</span>
            <span class="stat-value" id="cortisol">100%</span>
        </div>

        <div class="alert" id="alertBox">
            <strong>Alert:</strong> <span id="alertMsg"></span>
        </div>
    </div>

    <div class="camera-info">
        Mouse: Rotate • Wheel: Zoom • WASD: Move
    </div>

    <div id="debug"></div>

    <script>
        console.log('Starting 3D Rat Simulation...');
        
        // Debug function
        function debug(msg) {
            console.log(msg);
            const debugEl = document.getElementById('debug');
            debugEl.innerHTML += msg + '<br>';
            if (debugEl.children.length > 10) {
                debugEl.innerHTML = '';
            }
        }

        // Simple 3D Rat Class
        class Rat3D {
            constructor(x, y, z, id, scene) {
                this.id = id;
                this.scene = scene;
                this.position = new THREE.Vector3(x, y, z);
                this.velocity = new THREE.Vector3();
                this.target = new THREE.Vector3(x, y, z);
                
                // Behavioral properties from research
                this.age = Math.random() * 100;
                this.energy = 80 + Math.random() * 20;
                this.health = 90 + Math.random() * 10;
                this.stress = Math.random() * 20;
                this.corticosterone = 100;
                
                this.sex = Math.random() < 0.5 ? 'male' : 'female';
                this.dominance = Math.random();
                this.reproductiveAge = this.sex === 'female' ? 45 : 40;
                this.estrusDay = Math.random() * 5;
                this.gestationDays = 0;
                this.pregnancies = 0;
                
                this.state = 'foraging';
                this.socialInteractions = 0;
                this.territoryCenter = this.position.clone();
                this.territoryRadius = 2;
                
                this.lastStateChange = 0;
                this.lastTargetChange = 0;
                
                this.createModel();
            }
            
            createModel() {
                this.group = new THREE.Group();
                
                // Main body
                const bodyGeo = new THREE.SphereGeometry(0.12, 8, 6);
                bodyGeo.scale(1.5, 0.8, 1.2);
                
                const bodyMat = new THREE.MeshLambertMaterial({ color: this.getColor() });
                this.bodyMesh = new THREE.Mesh(bodyGeo, bodyMat);
                this.bodyMesh.position.y = 0.08;
                this.group.add(this.bodyMesh);
                
                // Head
                const headGeo = new THREE.SphereGeometry(0.07, 6, 5);
                const headMat = new THREE.MeshLambertMaterial({ color: this.getColor() });
                this.headMesh = new THREE.Mesh(headGeo, headMat);
                this.headMesh.position.set(0.15, 0.1, 0);
                this.group.add(this.headMesh);
                
                // Ears
                const earGeo = new THREE.SphereGeometry(0.025, 4, 3);
                const earMat = new THREE.MeshLambertMaterial({ color: 0xffb6c1 });
                
                const leftEar = new THREE.Mesh(earGeo, earMat);
                leftEar.position.set(0.18, 0.16, -0.04);
                this.group.add(leftEar);
                
                const rightEar = new THREE.Mesh(earGeo, earMat);
                rightEar.position.set(0.18, 0.16, 0.04);
                this.group.add(rightEar);
                
                // Tail
                const tailGeo = new THREE.CylinderGeometry(0.008, 0.015, 0.25, 4);
                const tailMat = new THREE.MeshLambertMaterial({ color: 0xd2b48c });
                const tail = new THREE.Mesh(tailGeo, tailMat);
                tail.position.set(-0.15, 0.04, 0);
                tail.rotation.z = Math.PI / 2;
                this.group.add(tail);
                
                // Position the group
                this.group.position.copy(this.position);
                this.scene.add(this.group);
                
                // Stress indicator
                const stressGeo = new THREE.RingGeometry(0.15, 0.18, 8);
                const stressMat = new THREE.MeshBasicMaterial({ 
                    color: 0xff0000, 
                    transparent: true, 
                    opacity: 0 
                });
                this.stressRing = new THREE.Mesh(stressGeo, stressMat);
                this.stressRing.rotation.x = -Math.PI / 2;
                this.stressRing.position.y = 0.01;
                this.group.add(this.stressRing);
                
                // Dominance indicator
                const crownGeo = new THREE.ConeGeometry(0.02, 0.04, 4);
                const crownMat = new THREE.MeshLambertMaterial({ color: 0x2196f3 });
                this.crown = new THREE.Mesh(crownGeo, crownMat);
                this.crown.position.set(0.15, 0.2, 0);
                this.crown.visible = false;
                this.group.add(this.crown);
                
                debug(`Created rat ${this.id} at (${x.toFixed(1)}, ${y.toFixed(1)}, ${z.toFixed(1)})`);
            }
            
            getColor() {
                if (this.age < 21) return 0xffeb3b; // yellow juveniles
                if (this.stress > 70) return 0x8b0000; // dark red stressed
                if (this.state === 'mating') return 0xdc143c; // crimson mating
                if (this.dominance > 0.8) return 0x4169e1; // blue alphas
                if (this.sex === 'female' && this.gestationDays > 0) return 0x9370db; // purple pregnant
                return 0x8b4513; // brown normal
            }
            
            update(deltaTime, environment) {
                this.age += deltaTime;
                this.updatePhysiology(deltaTime, environment);
                this.updateBehavior(deltaTime, environment);
                this.updateMovement(deltaTime);
                this.updateVisuals();
            }
            
            updatePhysiology(deltaTime, environment) {
                // Energy consumption based on state
                let consumption = 0.15; // basal
                if (this.state === 'foraging') consumption = 0.3;
                if (this.state === 'fleeing') consumption = 1.2;
                if (this.state === 'mating') consumption = 0.6;
                
                this.energy -= consumption * deltaTime;
                this.energy = Math.max(0, Math.min(100, this.energy));
                
                // Stress from density and social interactions
                let densityStress = Math.max(0, (environment.getPopulationDensity() - 0.75) * 150);
                let socialStress = Math.max(0, (this.socialInteractions - 12) * 8);
                this.stress = Math.min(100, densityStress + socialStress + (environment.generalStress || 0));
                
                // Corticosterone response
                this.corticosterone = 100 + (this.stress * 1.3);
                
                // Health effects
                if (this.stress > 70) this.health -= 0.15 * deltaTime;
                if (this.state === 'resting' && this.energy > 60) {
                    this.health += 0.08 * deltaTime;
                    this.stress = Math.max(0, this.stress - 0.3 * deltaTime);
                }
                this.health = Math.max(0, Math.min(100, this.health));
                
                // Reproductive cycle for females
                if (this.sex === 'female' && this.age > this.reproductiveAge) {
                    this.estrusDay += deltaTime;
                    if (this.estrusDay > 5) this.estrusDay = 0;
                    
                    if (this.gestationDays > 0) {
                        this.gestationDays -= deltaTime;
                        if (this.gestationDays <= 0) {
                            this.giveBirth(environment);
                        }
                    }
                }
            }
            
            updateBehavior(deltaTime, environment) {
                this.lastStateChange += deltaTime;
                
                if (this.lastStateChange > 0.8) {
                    let prob = Math.random();
                    
                    // Priority behaviors
                    if (this.energy < 25) {
                        this.state = 'foraging';
                    } else if (this.stress > 75) {
                        this.state = 'fleeing';
                    } else if (this.health < 35) {
                        this.state = 'resting';
                    } else if (this.canMate(environment) && prob < 0.25) {
                        this.state = 'mating';
                    } else {
                        // Normal transitions
                        if (this.state === 'resting' && prob < 0.15) {
                            this.state = 'foraging';
                        } else if (this.state === 'foraging' && prob < 0.08) {
                            this.state = 'resting';
                        }
                    }
                    
                    this.lastStateChange = 0;
                }
                
                // Reset social interactions periodically
                if (Math.random() < 0.015) {
                    this.socialInteractions = 0;
                }
            }
            
            canMate(environment) {
                if (this.age < this.reproductiveAge) return false;
                if (this.sex === 'female') {
                    if (this.estrusDay < 1 || this.estrusDay > 2.5) return false;
                    if (this.gestationDays > 0) return false;
                }
                if (this.stress > 55) return false;
                if (this.energy < 35) return false;
                return true;
            }
            
            giveBirth(environment) {
                let baseLitter = 8 + Math.random() * 4;
                let stressReduction = (this.stress / 100) * 0.5;
                let densityReduction = Math.max(0, (environment.getPopulationDensity() - 0.8) * 0.6);
                let litterSize = Math.max(1, Math.floor(baseLitter * (1 - stressReduction - densityReduction)));
                
                let survivalRate = 0.75;
                if (environment.getPopulationDensity() > 0.9) survivalRate = 0.35;
                if (this.stress > 50) survivalRate *= 0.7;
                if (this.health < 50) survivalRate *= 0.6;
                
                let cannibalismRisk = 0;
                if (environment.getPopulationDensity() > 0.85 && this.stress > 65) {
                    cannibalismRisk = 0.5;
                } else if (environment.getPopulationDensity() > 0.75) {
                    cannibalismRisk = 0.15;
                }
                
                let survivors = 0;
                for (let i = 0; i < litterSize; i++) {
                    if (Math.random() < survivalRate && Math.random() > cannibalismRisk) {
                        survivors++;
                        let newPos = this.position.clone();
                        newPos.x += (Math.random() - 0.5) * 0.4;
                        newPos.z += (Math.random() - 0.5) * 0.4;
                        newPos.x = Math.max(-4, Math.min(4, newPos.x));
                        newPos.z = Math.max(-4, Math.min(4, newPos.z));
                        environment.addRat(new Rat3D(newPos.x, newPos.y, newPos.z, environment.nextId++, environment.scene));
                    }
                }
                
                environment.totalBirths += survivors;
                environment.dailyBirths += survivors;
                
                this.pregnancies++;
                this.gestationDays = 0;
                this.energy -= 25;
                this.health -= 8;
                
                debug(`Rat ${this.id} gave birth to ${survivors}/${litterSize} pups`);
            }
            
            updateMovement(deltaTime) {
                this.lastTargetChange += deltaTime;
                
                // Set new target occasionally
                if (this.lastTargetChange > 1 + Math.random() * 2) {
                    let speed = 0.8;
                    if (this.state === 'foraging') speed = 1.2;
                    if (this.state === 'fleeing') speed = 2.0;
                    if (this.state === 'resting') speed = 0.3;
                    
                    if (this.state === 'fleeing') {
                        // Flee away from center or high-density areas
                        let fleeDir = this.position.clone().normalize();
                        if (fleeDir.length() === 0) fleeDir.set(Math.random() - 0.5, 0, Math.random() - 0.5);
                        this.target.copy(this.position).add(fleeDir.multiplyScalar(1.5));
                    } else {
                        // Move within territory
                        this.target.copy(this.territoryCenter);
                        this.target.x += (Math.random() - 0.5) * this.territoryRadius * 2;
                        this.target.z += (Math.random() - 0.5) * this.territoryRadius * 2;
                    }
                    
                    // Keep within bounds
                    this.target.x = Math.max(-4, Math.min(4, this.target.x));
                    this.target.z = Math.max(-4, Math.min(4, this.target.z));
                    this.target.y = 0.08;
                    
                    this.lastTargetChange = 0;
                }
                
                // Move towards target
                let direction = this.target.clone().sub(this.position);
                let distance = direction.length();
                
                if (distance > 0.05) {
                    direction.normalize();
                    let speed = 0.5;
                    if (this.state === 'foraging') speed = 0.8;
                    if (this.state === 'fleeing') speed = 1.5;
                    if (this.state === 'resting') speed = 0.2;
                    
                    this.velocity.copy(direction).multiplyScalar(speed);
                } else {
                    this.velocity.multiplyScalar(0.7);
                }
                
                this.position.add(this.velocity.clone().multiplyScalar(deltaTime));
                this.group.position.copy(this.position);
                
                // Rotate to face movement
                if (this.velocity.length() > 0.05) {
                    let angle = Math.atan2(this.velocity.x, this.velocity.z);
                    this.group.rotation.y = angle;
                }
            }
            
            updateVisuals() {
                // Update colors
                let newColor = this.getColor();
                this.bodyMesh.material.color.setHex(newColor);
                this.headMesh.material.color.setHex(newColor);
                
                // Stress indicator
                if (this.stress > 40) {
                    this.stressRing.material.opacity = (this.stress - 40) / 60 * 0.6;
                    this.stressRing.visible = true;
                } else {
                    this.stressRing.visible = false;
                }
                
                // Dominance indicator
                this.crown.visible = this.dominance > 0.8;
            }
            
            shouldDie(environment) {
                let baseDeath = 0.0001;
                let ageDeath = this.age > 600 ? (this.age - 600) / 300 * 0.003 : 0;
                let stressDeath = this.stress > 75 ? 0.001 : 0;
                let healthDeath = this.health < 25 ? 0.002 : 0;
                let energyDeath = this.energy < 10 ? 0.004 : 0;
                let densityDeath = environment.getPopulationDensity() > 0.85 ? 0.0008 : 0;
                
                return Math.random() < (baseDeath + ageDeath + stressDeath + healthDeath + energyDeath + densityDeath);
            }
            
            destroy() {
                this.scene.remove(this.group);
            }
        }

        // Lab Environment
        class LabEnvironment {
            constructor() {
                this.rats = [];
                this.nextId = 1;
                
                // Parameters
                this.carryingCapacity = 100;
                this.foodAvailability = 1.0;
                this.generalStress = 0;
                
                // Stats
                this.totalBirths = 0;
                this.totalDeaths = 0;
                this.dailyBirths = 0;
                this.dailyDeaths = 0;
                this.dayCounter = 0;
                
                this.initScene();
                this.createEnvironment();
                this.initPopulation();
                
                debug('Lab environment initialized');
            }
            
            initScene() {
                // Scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x2a2a2a);
                
                // Camera
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
                this.camera.position.set(6, 8, 6);
                this.camera.lookAt(0, 0, 0);
                
                // Renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(this.renderer.domElement);
                
                // Lights
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(8, 10, 8);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 1024;
                directionalLight.shadow.mapSize.height = 1024;
                this.scene.add(directionalLight);
                
                // Simple camera controls
                this.setupControls();
                
                window.addEventListener('resize', () => this.onResize(), false);
                
                debug('3D scene initialized');
            }
            
            setupControls() {
                let mouseDown = false;
                let mouseX = 0, mouseY = 0;
                let cameraDistance = 10;
                let cameraAngleX = 0.7;
                let cameraAngleY = 0.4;
                
                this.renderer.domElement.addEventListener('mousedown', (e) => {
                    mouseDown = true;
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
                
                document.addEventListener('mouseup', () => mouseDown = false);
                
                document.addEventListener('mousemove', (e) => {
                    if (!mouseDown) return;
                    
                    let deltaX = e.clientX - mouseX;
                    let deltaY = e.clientY - mouseY;
                    
                    cameraAngleX += deltaX * 0.01;
                    cameraAngleY += deltaY * 0.01;
                    cameraAngleY = Math.max(-Math.PI/3, Math.min(Math.PI/3, cameraAngleY));
                    
                    this.updateCamera(cameraDistance, cameraAngleX, cameraAngleY);
                    
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
                
                this.renderer.domElement.addEventListener('wheel', (e) => {
                    cameraDistance += e.deltaY * 0.01;
                    cameraDistance = Math.max(3, Math.min(20, cameraDistance));
                    this.updateCamera(cameraDistance, cameraAngleX, cameraAngleY);
                });
                
                this.updateCamera = (dist, angleX, angleY) => {
                    this.camera.position.x = Math.cos(angleX) * Math.cos(angleY) * dist;
                    this.camera.position.y = Math.sin(angleY) * dist + 2;
                    this.camera.position.z = Math.sin(angleX) * Math.cos(angleY) * dist;
                    this.camera.lookAt(0, 0, 0);
                };
            }
            
            createEnvironment() {
                // Floor
                const floorGeo = new THREE.PlaneGeometry(10, 10);
                const floorMat = new THREE.MeshLambertMaterial({ color: 0xf5f5f5 });
                const floor = new THREE.Mesh(floorGeo, floorMat);
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                this.scene.add(floor);
                
                // Walls
                const wallMat = new THREE.MeshLambertMaterial({ 
                    color: 0xdddddd, 
                    transparent: true, 
                    opacity: 0.4 
                });
                
                const wallHeight = 2;
                const wallThickness = 0.1;
                
                // Create 4 walls
                const walls = [
                    { pos: [0, wallHeight/2, 5], size: [10, wallHeight, wallThickness] },
                    { pos: [0, wallHeight/2, -5], size: [10, wallHeight, wallThickness] },
                    { pos: [5, wallHeight/2, 0], size: [wallThickness, wallHeight, 10] },
                    { pos: [-5, wallHeight/2, 0], size: [wallThickness, wallHeight, 10] }
                ];
                
                walls.forEach(wall => {
                    const wallGeo = new THREE.BoxGeometry(...wall.size);
                    const wallMesh = new THREE.Mesh(wallGeo, wallMat);
                    wallMesh.position.set(...wall.pos);
                    this.scene.add(wallMesh);
                });
                
                // Food stations
                const foodPositions = [[-2.5, 0.05, -2.5], [2.5, 0.05, -2.5], [-2.5, 0.05, 2.5], [2.5, 0.05, 2.5]];
                
                foodPositions.forEach(pos => {
                    const stationGeo = new THREE.CylinderGeometry(0.15, 0.15, 0.1, 8);
                    const stationMat = new THREE.MeshLambertMaterial({ color: 0xffd700 });
                    const station = new THREE.Mesh(stationGeo, stationMat);
                    station.position.set(...pos);
                    station.castShadow = true;
                    this.scene.add(station);
                });
                
                // Water dispensers
                const waterPositions = [[-3.5, 0.2, 0], [3.5, 0.2, 0]];
                
                waterPositions.forEach(pos => {
                    const dispenserGeo = new THREE.CylinderGeometry(0.04, 0.04, 0.3, 6);
                    const dispenserMat = new THREE.MeshLambertMaterial({ color: 0x4169e1 });
                    const dispenser = new THREE.Mesh(dispenserGeo, dispenserMat);
                    dispenser.position.set(...pos);
                    this.scene.add(dispenser);
                });
                
                debug('Environment created');
            }
            
            initPopulation() {
                // Start with 6 rats (optimal group size from research)
                for (let i = 0; i < 6; i++) {
                    let x = (Math.random() - 0.5) * 3;
                    let z = (Math.random() - 0.5) * 3;
                    this.addRat(new Rat3D(x, 0.08, z, this.nextId++, this.scene));
                }
                debug(`Initial population: ${this.rats.length} rats`);
            }
            
            addRat(rat) {
                this.rats.push(rat);
            }
            
            getPopulationDensity() {
                return this.rats.length / this.carryingCapacity;
            }
            
            update(deltaTime) {
                this.dayCounter += deltaTime;
                
                // Update all rats
                for (let i = this.rats.length - 1; i >= 0; i--) {
                    let rat = this.rats[i];
                    rat.update(deltaTime, this);
                    
                    // Check for death
                    if (rat.shouldDie(this)) {
                        rat.destroy();
                        this.rats.splice(i, 1);
                        this.totalDeaths++;
                        this.dailyDeaths++;
                    }
                }
                
                // Calculate social interactions
                this.calculateSocialInteractions();
                
                // Process mating
                this.processMating();
                
                // Daily reset
                if (this.dayCounter >= 1) {
                    this.dailyBirths = 0;
                    this.dailyDeaths = 0;
                    this.dayCounter = 0;
                }
            }
            
            calculateSocialInteractions() {
                for (let rat of this.rats) {
                    rat.socialInteractions = 0;
                    
                    for (let other of this.rats) {
                        if (rat !== other) {
                            let distance = rat.position.distanceTo(other.position);
                            if (distance < 0.5) {
                                rat.socialInteractions++;
                            }
                        }
                    }
                }
            }
            
            processMating() {
                let matingRats = this.rats.filter(r => r.state === 'mating' && r.age > r.reproductiveAge);
                
                for (let i = 0; i < matingRats.length; i++) {
                    let male = matingRats[i];
                    if (male.sex !== 'male') continue;
                    
                    for (let j = 0; j < matingRats.length; j++) {
                        let female = matingRats[j];
                        if (female.sex !== 'female' || female.gestationDays > 0) continue;
                        
                        let distance = male.position.distanceTo(female.position);
                        if (distance < 0.25) {
                            this.attemptMating(male, female);
                        }
                    }
                }
            }
            
            attemptMating(male, female) {
                // Mating success based on research
                let successProb = male.dominance > 0.8 ? 0.85 : 0.25;
                
                if (this.getPopulationDensity() > 0.8) successProb *= 0.6;
                if (male.stress > 50 || female.stress > 50) successProb *= 0.7;
                
                if (Math.random() < successProb && female.gestationDays === 0) {
                    female.gestationDays = 22; // 22-day gestation from research
                    male.state = 'resting';
                    female.state = 'resting';
                    
                    male.energy -= 4;
                    female.energy -= 2;
                    
                    debug(`Mating successful: Rat ${male.id} (α=${male.dominance.toFixed(2)}) + Rat ${female.id}`);
                }
            }
            
            getStatistics() {
                if (this.rats.length === 0) {
                    return {
                        totalPopulation: 0, adults: 0, juveniles: 0, 
                        birthRate: 0, deathRate: 0, densityPercent: 0,
                        avgStress: 0, avgCorticosterone: 100, avgSocialInteractions: 0,
                        stressLevel: 'Normal', aggressionLevel: 'Low', 
                        reproductionLevel: 'Normal', cannibalismLevel: 'None'
                    };
                }
                
                let adults = this.rats.filter(r => r.age >= 21).length;
                let juveniles = this.rats.filter(r => r.age < 21).length;
                let avgStress = this.rats.reduce((sum, r) => sum + r.stress, 0) / this.rats.length;
                let avgCorticosterone = this.rats.reduce((sum, r) => sum + r.corticosterone, 0) / this.rats.length;
                let avgSocialInteractions = this.rats.reduce((sum, r) => sum + r.socialInteractions, 0) / this.rats.length;
                
                // Behavioral indicators based on research thresholds
                let stressLevel = avgStress < 30 ? 'Normal' : avgStress < 60 ? 'Moderate' : 'Critical';
                let aggressionLevel = avgSocialInteractions < 8 ? 'Low' : avgSocialInteractions < 12 ? 'Moderate' : 'High';
                let reproductionLevel = this.getPopulationDensity() < 0.75 ? 'Normal' : 
                                      this.getPopulationDensity() < 0.9 ? 'Reduced' : 'Failing';
                let cannibalismLevel = (this.getPopulationDensity() > 0.9 && avgStress > 70) ? 'High' : 
                                      (this.getPopulationDensity() > 0.75) ? 'Moderate' : 'None';
                
                return {
                    totalPopulation: this.rats.length,
                    adults: adults,
                    juveniles: juveniles,
                    birthRate: this.dailyBirths,
                    deathRate: this.dailyDeaths,
                    densityPercent: Math.round(this.getPopulationDensity() * 100),
                    avgStress: Math.round(avgStress),
                    avgCorticosterone: Math.round(avgCorticosterone),
                    avgSocialInteractions: Math.round(avgSocialInteractions * 10) / 10,
                    stressLevel: stressLevel,
                    aggressionLevel: aggressionLevel,
                    reproductionLevel: reproductionLevel,
                    cannibalismLevel: cannibalismLevel
                };
            }
            
            updateParameters(params) {
                this.carryingCapacity = params.capacity;
                this.foodAvailability = params.food / 100;
                this.generalStress = (params.stress - 100) / 4;
            }
            
            onResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            render() {
                this.renderer.render(this.scene, this.camera);
            }
        }

        // Simulation Controller
        class SimulationController {
            constructor() {
                this.environment = new LabEnvironment();
                this.isRunning = false;
                this.speed = 3;
                this.lastTime = 0;
                
                this.setupUI();
                this.startRenderLoop();
                this.updateDisplay();
                
                debug('Simulation controller ready');
                
                // Auto-start after short delay
                setTimeout(() => {
                    this.start();
                    debug('Auto-started simulation');
                }, 1000);
            }
            
            setupUI() {
                // Slider controls
                const sliders = {
                    capacity: (val) => {
                        document.getElementById('capacityVal').textContent = val;
                        this.updateParams();
                    },
                    food: (val) => {
                        document.getElementById('foodVal').textContent = val + '%';
                        this.updateParams();
                    },
                    stress: (val) => {
                        let level = val < 80 ? 'Low' : val < 120 ? 'Normal' : 'High';
                        document.getElementById('stressVal').textContent = level;
                        this.updateParams();
                    },
                    speed: (val) => {
                        document.getElementById('speedVal').textContent = val + 'x';
                        this.speed = parseInt(val);
                    }
                };
                
                Object.keys(sliders).forEach(id => {
                    const slider = document.getElementById(id);
                    if (slider) {
                        slider.addEventListener('input', () => sliders[id](slider.value));
                        sliders[id](slider.value); // Initialize
                    }
                });
                
                // Button controls
                document.getElementById('startBtn').addEventListener('click', () => this.start());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pause());
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
                
                // Camera controls
                document.getElementById('topView').addEventListener('click', () => this.setTopView());
                document.getElementById('sideView').addEventListener('click', () => this.setSideView());
                document.getElementById('freeView').addEventListener('click', () => this.setFreeView());
                
                debug('UI controls initialized');
            }
            
            updateParams() {
                const params = {
                    capacity: parseInt(document.getElementById('capacity').value),
                    food: parseInt(document.getElementById('food').value),
                    stress: parseInt(document.getElementById('stress').value)
                };
                this.environment.updateParameters(params);
            }
            
            setTopView() {
                this.environment.camera.position.set(0, 12, 0);
                this.environment.camera.lookAt(0, 0, 0);
            }
            
            setSideView() {
                this.environment.camera.position.set(10, 5, 0);
                this.environment.camera.lookAt(0, 0, 0);
            }
            
            setFreeView() {
                this.environment.camera.position.set(6, 8, 6);
                this.environment.camera.lookAt(0, 0, 0);
            }
            
            start() {
                this.isRunning = true;
                this.lastTime = performance.now();
                this.simulate();
                debug('Simulation started');
            }
            
            pause() {
                this.isRunning = false;
                debug('Simulation paused');
            }
            
            reset() {
                // Clear existing rats
                this.environment.rats.forEach(rat => rat.destroy());
                this.environment.rats = [];
                this.environment.nextId = 1;
                this.environment.totalBirths = 0;
                this.environment.totalDeaths = 0;
                this.environment.dailyBirths = 0;
                this.environment.dailyDeaths = 0;
                
                // Reinitialize
                this.environment.initPopulation();
                this.updateParams();
                this.updateDisplay();
                
                debug('Simulation reset');
            }
            
            simulate() {
                if (!this.isRunning) return;
                
                const currentTime = performance.now();
                const deltaTime = (currentTime - this.lastTime) / 1000 * this.speed * 0.08;
                this.lastTime = currentTime;
                
                if (deltaTime > 0 && deltaTime < 0.3) {
                    this.environment.update(deltaTime);
                    this.updateDisplay();
                    this.checkAlerts();
                }
                
                setTimeout(() => this.simulate(), 50); // 20 FPS simulation
            }
            
            startRenderLoop() {
                const renderLoop = () => {
                    this.environment.render();
                    requestAnimationFrame(renderLoop);
                };
                renderLoop();
            }
            
            updateDisplay() {
                const stats = this.environment.getStatistics();
                
                // Population stats
                document.getElementById('totalPop').textContent = stats.totalPopulation;
                document.getElementById('adults').textContent = stats.adults;
                document.getElementById('juveniles').textContent = stats.juveniles;
                document.getElementById('births').textContent = stats.birthRate;
                document.getElementById('deaths').textContent = stats.deathRate;
                
                // Behavioral status
                document.getElementById('stressLevel').textContent = stats.stressLevel;
                document.getElementById('aggressionLevel').textContent = stats.aggressionLevel;
                document.getElementById('reproductionLevel').textContent = stats.reproductionLevel;
                document.getElementById('cannibalismLevel').textContent = stats.cannibalismLevel;
                
                // Research data
                document.getElementById('density').textContent = stats.densityPercent + '%';
                document.getElementById('interactions').textContent = stats.avgSocialInteractions;
                document.getElementById('cortisol').textContent = stats.avgCorticosterone + '%';
                
                // Critical status indicators
                const statusElements = {
                    stressStatus: stats.stressLevel === 'Critical',
                    aggressionStatus: stats.aggressionLevel === 'High',
                    reproductionStatus: stats.reproductionLevel === 'Failing',
                    cannibalismStatus: stats.cannibalismLevel === 'High'
                };
                
                Object.keys(statusElements).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.className = statusElements[id] ? 'status-item critical' : 'status-item';
                    }
                });
            }
            
            checkAlerts() {
                const stats = this.environment.getStatistics();
                const alertBox = document.getElementById('alertBox');
                const alertMsg = document.getElementById('alertMsg');
                
                let alert = null;
                
                if (stats.densityPercent >= 75 && stats.stressLevel === 'Critical') {
                    alert = 'BEHAVIORAL SINK DETECTED! Population density >75% with critical stress levels. Social breakdown imminent.';
                } else if (stats.avgSocialInteractions > 12) {
                    alert = 'Social interaction threshold exceeded (>12 per rat). Behavioral breakdown threshold reached.';
                } else if (stats.avgCorticosterone > 200) {
                    alert = 'Severe chronic stress detected. Corticosterone levels indicate pathological response.';
                } else if (stats.cannibalismLevel === 'High') {
                    alert = 'High cannibalism risk due to overcrowding and stress. Up to 96% infanticide rate possible.';
                } else if (stats.reproductionLevel === 'Failing') {
                    alert = 'Reproductive failure occurring. Population declining despite adequate resources.';
                } else if (stats.densityPercent >= 75) {
                    alert = 'Approaching behavioral sink threshold. Monitor stress levels carefully.';
                }
                
                if (alert) {
                    alertMsg.textContent = alert;
                    alertBox.classList.add('show');
                } else {
                    alertBox.classList.remove('show');
                }
            }
        }

        // Initialize when Three.js is loaded
        if (typeof THREE !== 'undefined') {
            debug('Three.js loaded successfully');
            document.addEventListener('DOMContentLoaded', () => {
                debug('DOM ready, starting simulation...');
                new SimulationController();
            });
        } else {
            debug('ERROR: Three.js failed to load');
            document.body.innerHTML = '<div style="color: red; padding: 20px; font-size: 20px;">ERROR: Three.js failed to load. Please refresh the page.</div>';
        }
    </script>
</body>
</html>